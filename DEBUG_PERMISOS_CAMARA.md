# üîç Debug: Permisos de C√°mara - Modo P√°nico Extremo

## üéØ Problema Reportado

Al activar "Modo P√°nico Extremo" dice que los permisos est√°n denegados, pero en realidad no lo est√°n.

## ‚úÖ Soluci√≥n Implementada

He mejorado la funci√≥n para que:
1. ‚úÖ Siempre INTENTE solicitar permisos al marcar el checkbox
2. ‚úÖ Muestre el di√°logo del navegador autom√°ticamente
3. ‚úÖ Agregue logs detallados en consola
4. ‚úÖ Maneje errores espec√≠ficos con mensajes claros

## üß™ C√≥mo Diagnosticar

### Paso 1: Limpiar Estado Previo

```
1. Presiona F12 (abrir DevTools)
2. Ve a la pesta√±a "Application" (o "Aplicaci√≥n")
3. En el men√∫ izquierdo: "Storage" ‚Üí "Clear site data"
4. Click "Clear site data"
5. Cerrar navegador completamente
6. Abrir navegador de nuevo
```

### Paso 2: Probar con Consola Abierta

```
1. Ir a http://localhost:3000/residentes/panico
2. Presionar F12 (mantener abierto)
3. Tab "Console"
4. Tab "Configuraci√≥n" (en la p√°gina)
5. Marcar checkbox "Modo P√°nico Extremo"
   ‚Üì
   OBSERVAR EN CONSOLA:
```

### Logs Esperados (Caso Exitoso):

```javascript
üé• Modo extremo: ACTIVADO
üé• Solicitando permisos de c√°mara autom√°ticamente...
üé• Solicitando permisos de c√°mara al navegador...

// El navegador muestra di√°logo:
// "localhost:3000 quiere usar tu c√°mara y micr√≥fono"
// [Bloquear] [Permitir]

// Usuario hace click "Permitir":

‚úÖ Permisos de c√°mara otorgados exitosamente
üõë Deteniendo track: video
üõë Deteniendo track: audio
```

### Si Ves Error en Consola:

```javascript
‚ùå Error al solicitar permisos de c√°mara: [Error]
Error name: NotAllowedError
Error message: Permission denied
```

Esto indica que el usuario bloque√≥ los permisos.

## üîß Soluciones Seg√∫n el Error

### Error: "NotAllowedError" (Permisos Bloqueados)

**Causa**: El navegador tiene permisos bloqueados para este sitio.

**Soluci√≥n**:

#### Chrome/Edge:
```
1. Click en el icono üîí (a la izquierda de la URL)
2. Buscar "C√°mara"
3. Cambiar de "Bloquear" a "Permitir"
4. Recargar p√°gina (F5)
5. Marcar "Modo P√°nico Extremo" de nuevo
```

#### Firefox:
```
1. Click en el icono üõ°Ô∏è (a la izquierda de la URL)
2. Click en "‚ñ∂" o "M√°s informaci√≥n"
3. Buscar "Usar la c√°mara"
4. Cambiar a "Permitir"
5. Recargar p√°gina (F5)
6. Marcar "Modo P√°nico Extremo" de nuevo
```

### Error: "NotFoundError" (Sin C√°mara)

**Causa**: No hay c√°mara conectada al dispositivo.

**Soluci√≥n**:
```
1. Verificar que tu dispositivo tenga c√°mara web
2. Si es laptop, verificar que est√© conectada
3. Si es USB, reconectar
4. En Windows: Configuraci√≥n ‚Üí Privacidad ‚Üí C√°mara ‚Üí Permitir apps
```

### Error: "NotReadableError" (C√°mara en Uso)

**Causa**: Otra aplicaci√≥n est√° usando la c√°mara.

**Soluci√≥n**:
```
1. Cerrar: Zoom, Teams, Skype, Discord, etc.
2. Cerrar otras pesta√±as que usen c√°mara
3. Reintentar
```

### No Aparece el Di√°logo

**Causa**: Permisos ya fueron bloqueados anteriormente.

**Soluci√≥n**:
```
1. Limpiar permisos del sitio
2. Chrome: chrome://settings/content/siteDetails?site=http://localhost:3000
3. Restablecer permisos
4. Recargar p√°gina
5. Intentar de nuevo
```

## üß™ Test Visual Paso a Paso

### Test 1: Desde Cero (Estado Limpio)

```
PREPARACI√ìN:
1. Limpiar datos del sitio (F12 ‚Üí Application ‚Üí Clear site data)
2. Cerrar y abrir navegador
3. Ir a http://localhost:3000/residentes/panico
4. F12 ‚Üí Console (dejar abierto)

ACTIVACI√ìN:
5. Tab "Configuraci√≥n"
6. Scroll a "Modo P√°nico Extremo"
7. Marcar checkbox
   ‚Üì

DEBE PASAR:
‚úì Checkbox se marca visualmente
‚úì Aparece secci√≥n "Estado de la C√°mara"
‚úì Badge amarillo: "‚è≥ Sin Configurar"
‚úì Aparece bot√≥n: "üé• Activar Permisos de C√°mara"
‚úì Toast: "üìπ Solicitando permisos de c√°mara..."
‚úì DI√ÅLOGO DEL NAVEGADOR APARECE:
  "localhost:3000 quiere usar tu c√°mara y micr√≥fono"
  [Bloquear] [Permitir]

8. Click "Permitir"
   ‚Üì

RESULTADO:
‚úì Badge cambia a verde: "‚úì C√°mara Lista"
‚úì Mensaje: "C√°mara configurada y lista para emergencias"
‚úì Toast verde: "‚úì Permisos de c√°mara otorgados correctamente"
‚úì En consola: "‚úÖ Permisos de c√°mara otorgados exitosamente"
```

### Test 2: Con Bot√≥n Manual

Si el di√°logo NO apareci√≥ autom√°ticamente:

```
1. Marcar "Modo P√°nico Extremo"
2. Ver badge amarillo "‚è≥ Sin Configurar"
3. Click en bot√≥n "üé• Activar Permisos de C√°mara"
   ‚Üì
4. DEBE aparecer di√°logo del navegador
5. Click "Permitir"
   ‚Üì
6. Badge cambia a verde
```

## üîç Verificar Permisos en el Navegador

### Chrome/Edge:

```
1. Click derecho en p√°gina
2. "Inspeccionar"
3. Tab "Console"
4. Escribir:
   navigator.permissions.query({name: 'camera'})
   
5. Debe mostrar:
   PermissionStatus {state: "granted", ...}
   
   Si dice "denied": Permisos bloqueados
   Si dice "granted": Permisos otorgados
   Si dice "prompt": A√∫n no se han pedido
```

### Verificar Dispositivos Disponibles:

```
En Console:
navigator.mediaDevices.enumerateDevices()

Debe mostrar:
[
  {kind: "videoinput", label: "C√°mara frontal", ...},
  {kind: "audioinput", label: "Micr√≥fono", ...},
  ...
]

Si NO hay "videoinput": No tienes c√°mara
```

## üí° Comandos de Depuraci√≥n

Abre la consola (F12) y prueba estos comandos:

### 1. Verificar si el navegador soporta c√°mara:

```javascript
'mediaDevices' in navigator && navigator.mediaDevices.getUserMedia
// Debe devolver: true
```

### 2. Ver permisos actuales:

```javascript
navigator.permissions.query({name: 'camera'}).then(r => console.log(r.state))
// Debe mostrar: "granted", "denied" o "prompt"
```

### 3. Solicitar c√°mara manualmente:

```javascript
navigator.mediaDevices.getUserMedia({video: true, audio: true})
  .then(stream => {
    console.log('‚úÖ Permisos OK');
    stream.getTracks().forEach(t => t.stop());
  })
  .catch(err => console.error('‚ùå Error:', err.name, err.message));
```

## üé¨ Qu√© Debe Pasar (Video Tutorial)

### Secuencia Visual Correcta:

```
Acci√≥n: Marcar checkbox "Modo P√°nico Extremo"
   ‚Üì 0.1s
Checkbox: Se marca visualmente ‚úì
   ‚Üì 0.1s
Secci√≥n: Aparece "Estado de la C√°mara: ‚è≥ Sin Configurar"
   ‚Üì 0.1s
Toast: "üìπ Solicitando permisos de c√°mara..."
   ‚Üì 0.2s
Navegador: MUESTRA DI√ÅLOGO NATIVO
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ localhost:3000 quiere:                ‚îÇ
‚îÇ ‚Ä¢ Usar tu c√°mara                      ‚îÇ
‚îÇ ‚Ä¢ Usar tu micr√≥fono                   ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ [ Bloquear ]        [ Permitir ]      ‚îÇ ‚Üê ESTE DI√ÅLOGO
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚Üì
Usuario: Click "Permitir"
   ‚Üì 0.5s
C√°mara: Se enciende brevemente (luz verde si es laptop)
   ‚Üì 1s
C√°mara: Se apaga autom√°ticamente
   ‚Üì 0.1s
Toast: "‚úì Permisos de c√°mara otorgados correctamente"
   ‚Üì 0.1s
Badge: Cambia a verde "‚úì C√°mara Lista"
   ‚Üì 0.1s
Mensaje: "C√°mara configurada y lista para emergencias"
```

## ‚ùå Si NO Aparece el Di√°logo

### Causa 1: Permisos Ya Otorgados

Si los permisos ya est√°n otorgados:
- El di√°logo NO aparece
- La c√°mara se activa silenciosamente
- Se prueba y se apaga
- Badge cambia a verde directamente

**Esto es NORMAL y correcto**.

### Causa 2: Permisos Ya Bloqueados

Si bloqueaste permisos antes:
- El di√°logo NO aparece
- Inmediatamente falla
- Badge cambia a rojo
- Toast de error aparece

**Soluci√≥n**: Desbloquear en configuraci√≥n del navegador.

### Causa 3: HTTPS Requerido

Algunos navegadores requieren HTTPS para c√°mara.

**En desarrollo (localhost)**: Deber√≠a funcionar sin HTTPS  
**En producci√≥n**: DEBE usar HTTPS

## üîß Soluci√≥n Definitiva

### Opci√≥n 1: Resetear Permisos Completamente

```bash
# Chrome/Edge:
1. chrome://settings/content/siteDetails?site=http://localhost:3000
2. Scroll a "Permisos"
3. C√°mara ‚Üí "Preguntar (predeterminado)"
4. Cerrar pesta√±a de configuraci√≥n
5. Volver a la app
6. Recargar (F5)
7. Marcar modo extremo
8. DEBE aparecer di√°logo
```

### Opci√≥n 2: Usar Bot√≥n Manual

Si el autom√°tico falla:

```
1. Marcar "Modo P√°nico Extremo"
2. Ignorar si dice "Sin Configurar"
3. Click en bot√≥n "üé• Activar Permisos de C√°mara"
4. DEBE aparecer di√°logo
5. Permitir
6. Badge cambia a verde
```

### Opci√≥n 3: Probar en Navegador Diferente

```
Firefox / Chrome / Edge

Si funciona en uno pero no en otro:
‚Üí El problema es espec√≠fico del navegador
‚Üí Limpiar datos de ese navegador
```

## üìù Checklist de Diagn√≥stico

Marca lo que ves:

Al marcar "Modo P√°nico Extremo":
- [ ] Checkbox se marca visualmente
- [ ] Aparece secci√≥n "Estado de la C√°mara"
- [ ] Toast: "Solicitando permisos de c√°mara..."
- [ ] **¬øAparece di√°logo del navegador?** ‚Üê CR√çTICO
- [ ] Despu√©s de permitir: Badge verde
- [ ] Mensaje: "C√°mara configurada y lista"

En la CONSOLA (F12 ‚Üí Console):
- [ ] "üé• Modo extremo: ACTIVADO"
- [ ] "üé• Solicitando permisos..."
- [ ] "‚úÖ Permisos otorgados" O "‚ùå Error..."

## üÜò Si Sigue Sin Funcionar

Ejecuta este comando en la consola del navegador (F12):

```javascript
// Test completo de c√°mara
navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}, audio: true})
  .then(stream => {
    console.log('‚úÖ √âXITO - C√°mara funciona');
    console.log('Video tracks:', stream.getVideoTracks().length);
    console.log('Audio tracks:', stream.getAudioTracks().length);
    stream.getTracks().forEach(t => t.stop());
    alert('‚úÖ Tu c√°mara funciona correctamente. El problema puede ser de c√≥digo.');
  })
  .catch(err => {
    console.error('‚ùå ERROR:', err.name, '-', err.message);
    if (err.name === 'NotAllowedError') {
      alert('‚ùå Permisos BLOQUEADOS en el navegador. Ve a configuraci√≥n.');
    } else if (err.name === 'NotFoundError') {
      alert('‚ùå NO se encontr√≥ c√°mara en tu dispositivo.');
    } else {
      alert('‚ùå Error: ' + err.message);
    }
  });
```

Y dime qu√© mensaje aparece.

## üìä Estados Posibles

| Badge | Significado | Qu√© Hacer |
|-------|-------------|-----------|
| üü¢ ‚úì C√°mara Lista | Permisos OK | ‚úÖ Nada, todo bien |
| üü° ‚è≥ Sin Configurar | No se han pedido | üìç Click bot√≥n "Activar" |
| üî¥ ‚úó Permisos Denegados | Bloqueados | ‚öôÔ∏è Ir a config navegador |

## üéØ Flujo Correcto

```
Usuario marca checkbox
   ‚Üì
onChange se ejecuta
   ‚Üì
setExtremeModeEnabled(true)
   ‚Üì
setTimeout 100ms (para que checkbox se marque)
   ‚Üì
requestCameraPermission() se llama
   ‚Üì
navigator.mediaDevices.getUserMedia({...})
   ‚Üì
[DI√ÅLOGO DEL NAVEGADOR DEBE APARECER AQU√ç]
   ‚Üì
Usuario click "Permitir"
   ‚Üì
Stream obtenido
   ‚Üì
setCameraPermissionStatus('granted')
   ‚Üì
stream.getTracks().forEach(track => track.stop())
   ‚Üì
Toast verde + Badge verde
```

## üîç Verificaci√≥n Directa en Navegador

### Ver Permisos Otorgados:

**Chrome**:
```
1. chrome://settings/content/camera
2. Buscar "localhost:3000"
3. Debe decir "Permitir"
```

**Firefox**:
```
1. about:preferences#privacy
2. Scroll a "Permisos"
3. C√°mara ‚Üí Configuraci√≥n
4. Buscar "localhost:3000"
5. Debe estar en "Permitir"
```

## üí° Consejo Pro

Prueba en **ventana de inc√≥gnito**:

```
1. Ctrl + Shift + N (Chrome) o Ctrl + Shift + P (Firefox)
2. Ir a http://localhost:3000/residentes/panico
3. Login
4. Configuraci√≥n
5. Marcar modo extremo
6. Permitir cuando pregunte

Si funciona en inc√≥gnito pero no en normal:
‚Üí El problema son permisos guardados en navegador normal
‚Üí Soluci√≥n: Limpiar datos del sitio
```

## üé¨ Video de Qu√© Debe Pasar

Cuando marcas el checkbox:

```
Segundo 0.0: Click en checkbox
Segundo 0.1: Checkbox marcado ‚úì
Segundo 0.2: Toast "Solicitando permisos..."
Segundo 0.3: DI√ÅLOGO APARECE ‚Üê ESTE ES EL CR√çTICO
Segundo X.X: Usuario click "Permitir"
Segundo X.X+0.5: Luz de c√°mara parpadea
Segundo X.X+1.0: Luz se apaga
Segundo X.X+1.1: Badge verde aparece
Segundo X.X+1.2: Toast "Permisos otorgados"
```

**Si NO ves el DI√ÅLOGO en el Segundo 0.3**:
‚Üí Los permisos est√°n bloqueados en el navegador
‚Üí Necesitas ir a configuraci√≥n del navegador

## üìû Necesito Informaci√≥n

Para ayudarte mejor, dime:

1. **¬øQu√© navegador usas?** (Chrome, Firefox, Edge)
2. **¬øAparece el di√°logo del navegador?** (S√≠/No)
3. **¬øQu√© dice la consola?** (F12 ‚Üí Console ‚Üí copiar mensajes)
4. **¬øFuncion√≥ el test manual?** (el c√≥digo JavaScript de arriba)
5. **¬øFunciona en ventana inc√≥gnito?** (S√≠/No)

Con esa info puedo darte la soluci√≥n exacta.

---

**Estado**: üîß Mejoras Implementadas  
**Siguiente Paso**: Probar con consola abierta y reportar logs  
**Objetivo**: Que el di√°logo del navegador aparezca correctamente


