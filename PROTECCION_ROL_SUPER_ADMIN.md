# Protecci√≥n del Rol Super-Admin

## üìã Resumen

Se ha implementado una protecci√≥n completa en m√∫ltiples niveles para el rol de Super Administrador:

1. **Solo el super administrador principal (mar90jesus@gmail.com)** puede asignar el rol de `super_admin` a otros usuarios
2. **Solo super-admins pueden editar a otros super-admins** - Los admins regulares no pueden editar usuarios con rol `super_admin`
3. **NADIE puede editar al super-admin principal** - El usuario mar90jesus@gmail.com est√° completamente protegido de cualquier modificaci√≥n

## üéØ Objetivos

### Restricciones para Usuarios Admin (No Super-Admin)
- ‚ùå NO pueden crear nuevos usuarios con rol `super_admin`
- ‚ùå NO pueden cambiar el rol de usuarios existentes a `super_admin`
- ‚ùå NO pueden aprobar solicitudes de registro con rol `super_admin`
- ‚ùå NO pueden editar a usuarios que ya son `super_admin`
- ‚ùå NO pueden ver el bot√≥n de editar para usuarios `super_admin`
- ‚ùå NO pueden eliminar a usuarios `super_admin`
- ‚ùå NO pueden desactivar a usuarios `super_admin`
- ‚ùå NO pueden ver botones de eliminar/desactivar para usuarios `super_admin`

### Restricciones para Super-Admins (Excepto el Principal)
- ‚úÖ PUEDEN editar a otros super-admins
- ‚úÖ PUEDEN editar a usuarios de cualquier rol
- ‚úÖ PUEDEN eliminar a otros super-admins
- ‚úÖ PUEDEN desactivar a otros super-admins
- ‚ùå NO pueden asignar el rol `super_admin` (solo el principal)
- ‚ùå NO pueden editar al super-admin principal (mar90jesus@gmail.com)
- ‚ùå NO pueden eliminar al super-admin principal
- ‚ùå NO pueden desactivar al super-admin principal

### Protecciones para el Super-Admin Principal (mar90jesus@gmail.com)
- ‚úÖ Control total sobre todos los usuarios
- ‚úÖ √önico que puede asignar el rol `super_admin`
- üîí **NADIE puede editarlo** (ni siquiera otros super-admins)
- üîí **NADIE puede eliminarlo** (protecci√≥n absoluta)
- üîí **NADIE puede desactivarlo** (protecci√≥n absoluta)

## ‚úÖ Cambios Implementados

### 1. Nueva Funci√≥n: canEditSpecificUser
**Archivo:** `app/admin/admin-dashboard/page.tsx`

**Cambios:**
- Se cre√≥ una nueva funci√≥n `canEditSpecificUser(targetUser)` que determina si el usuario actual puede editar a un usuario espec√≠fico
- La funci√≥n implementa las siguientes reglas:
  - NADIE puede editar al super-admin principal (mar90jesus@gmail.com)
  - Solo super-admins pueden editar a otros super-admins
  - Para otros usuarios, se verifican los permisos normales

```tsx
const canEditSpecificUser = (targetUser: UserProfile) => {
  if (!userProfile) return false;
  
  // NADIE puede editar al super-admin principal
  if (isMainSuperAdmin(targetUser.email)) {
    return false;
  }
  
  // Solo super-admins pueden editar a otros super-admins
  if (targetUser.role === 'super_admin') {
    return userProfile.role === 'super_admin';
  }
  
  // Para otros usuarios, verificar permisos normales
  return canEditUsers();
};
```

### 2. Protecci√≥n Visual - Bot√≥n de Editar
**Archivo:** `app/admin/admin-dashboard/page.tsx`

**Cambios:**
- El bot√≥n de editar ahora usa `canEditSpecificUser(user)` en lugar de solo `canEditUsers()`
- Los admins ya NO ven el bot√≥n de editar para usuarios super-admin
- El super-admin principal no tiene bot√≥n de editar visible para nadie

```tsx
{canEditSpecificUser(user) && (
  <button onClick={() => setShowEditUser(user)}>
    <Edit className="w-4 h-4" />
  </button>
)}
```

### 3. Nueva Funci√≥n: canDeleteOrDeactivateSpecificUser
**Archivo:** `app/admin/admin-dashboard/page.tsx`

**Cambios:**
- Se cre√≥ una nueva funci√≥n `canDeleteOrDeactivateSpecificUser(targetUser)` que determina si el usuario actual puede eliminar o desactivar a un usuario espec√≠fico
- La funci√≥n implementa las siguientes reglas:
  - NADIE puede eliminar/desactivar al super-admin principal (mar90jesus@gmail.com)
  - Solo super-admins pueden eliminar/desactivar a otros super-admins
  - Para otros usuarios, se verifican los permisos normales

```tsx
const canDeleteOrDeactivateSpecificUser = (targetUser: UserProfile) => {
  if (!userProfile) return false;
  
  // NADIE puede eliminar/desactivar al super-admin principal
  if (isMainSuperAdmin(targetUser.email)) {
    return false;
  }
  
  // Solo super-admins pueden eliminar/desactivar a otros super-admins
  if (targetUser.role === 'super_admin') {
    return userProfile.role === 'super_admin';
  }
  
  // Para otros usuarios, verificar permisos normales
  return canDeleteUser(targetUser.email);
};
```

### 4. Protecci√≥n Visual - Botones de Eliminar/Desactivar
**Archivo:** `app/admin/admin-dashboard/page.tsx`

**Cambios:**
- Los botones de eliminar y desactivar ahora usan `canDeleteOrDeactivateSpecificUser(user)` en lugar de solo `canDeleteUser()`
- Los admins ya NO ven botones de eliminar/desactivar para usuarios super-admin
- El super-admin principal no tiene botones de eliminar/desactivar visibles para nadie

```tsx
{canDeleteOrDeactivateSpecificUser(user) && (
  <>
    {/* Botones de desactivar, eliminar, etc. */}
  </>
)}
```

### 5. Validaci√≥n en handleUpdateUser
**Archivo:** `app/admin/admin-dashboard/page.tsx`

**Cambios:**
- Se agregaron validaciones m√∫ltiples antes de permitir la actualizaci√≥n:
  - Verifica que no se est√© intentando editar al super-admin principal
  - Verifica que solo super-admins puedan editar a otros super-admins
  - Mensajes de error claros y espec√≠ficos

```tsx
// NADIE puede editar al super-admin principal
if (isMainSuperAdmin(userEmail)) {
  alert('‚ùå No se puede editar al super administrador principal');
  return;
}

// Solo super-admins pueden editar a otros super-admins
if (targetUser.role === 'super_admin' && userProfile.role !== 'super_admin') {
  alert('‚ùå Solo un super administrador puede editar a otro super administrador');
  return;
}
```

### 6. Validaciones en handleDeleteUser y showConfirmationModal
**Archivo:** `app/admin/admin-dashboard/page.tsx`

**Cambios:**
- Se agregaron validaciones en `handleDeleteUser()` antes de intentar eliminar
- Se agregaron validaciones en `showConfirmationModal()` antes de mostrar el modal de confirmaci√≥n
- Validaciones en `handleConfirmAction()` antes de ejecutar la acci√≥n
- Mensajes de error espec√≠ficos seg√∫n el tipo de intento de violaci√≥n

```tsx
// En handleDeleteUser
if (!canDeleteOrDeactivateSpecificUser(user)) {
  if (isMainSuperAdmin(user.email)) {
    alert('‚ùå No se puede eliminar al super administrador principal');
  } else if (user.role === 'super_admin' && userProfile?.role !== 'super_admin') {
    alert('‚ùå Solo un super administrador puede eliminar a otro super administrador');
  }
  return;
}
```

### 7. Interfaz de Usuario - Modal de Crear Usuario
**Archivo:** `app/admin/admin-dashboard/page.tsx`

**Cambios:**
- Se a√±adi√≥ el hook `useAuth()` al componente `CreateUserModal` para obtener el perfil del usuario actual
- Se agreg√≥ validaci√≥n `isMainSuperAdminUser` para verificar si el usuario actual es `mar90jesus@gmail.com`
- La opci√≥n "Super Administrador" en el selector de roles **solo se muestra** si el usuario es el super-admin principal
- Se agreg√≥ un mensaje informativo cuando la opci√≥n no est√° disponible

```tsx
{isMainSuperAdminUser && (
  <option value="super_admin">Super Administrador</option>
)}
{!isMainSuperAdminUser && (
  <p className="text-xs text-gray-500 mt-1">
    ‚ÑπÔ∏è Solo el super administrador principal puede asignar el rol de Super Administrador
  </p>
)}
```

### 2. Interfaz de Usuario - Modal de Editar Usuario
**Archivo:** `app/admin/admin-dashboard/page.tsx`

**Cambios:**
- Se a√±adi√≥ el hook `useAuth()` al componente `EditUserModal` para obtener el perfil del usuario actual
- Se agreg√≥ validaci√≥n `isMainSuperAdminUser` para verificar si el usuario actual es `mar90jesus@gmail.com`
- La opci√≥n "Super Administrador" en el selector de roles **solo se muestra** si el usuario es el super-admin principal
- Se agreg√≥ un mensaje informativo cuando la opci√≥n no est√° disponible

```tsx
{isMainSuperAdminUser && (
  <option value="super_admin">Super Administrador</option>
)}
{!isMainSuperAdminUser && !isMainSuperAdmin(user.email) && (
  <p className="text-xs text-gray-500 mt-1">
    ‚ÑπÔ∏è Solo el super administrador principal puede asignar el rol de Super Administrador
  </p>
)}
```

### 3. Backend - API de Creaci√≥n de Usuarios
**Archivo:** `app/api/admin/create-user/route.ts`

**Cambios:**
- Se agreg√≥ validaci√≥n de servidor para verificar que solo `mar90jesus@gmail.com` puede crear usuarios con rol `super_admin`
- Retorna error 403 (Forbidden) si un usuario no autorizado intenta asignar el rol

```typescript
// üîê PROTECCI√ìN: Solo el super-admin principal puede asignar el rol de super_admin
if (role === 'super_admin' && createdBy !== 'mar90jesus@gmail.com') {
  return NextResponse.json(
    { error: 'Solo el super administrador principal puede asignar el rol de Super Administrador' },
    { status: 403 }
  );
}
```

### 4. Backend - Funci√≥n de Actualizaci√≥n de Usuarios (MEJORADA)
**Archivo:** `lib/auth.ts` - Funci√≥n `updateUserAsAdmin`

**Cambios:**
- Se agregaron **TRES niveles de protecci√≥n** en el backend:
  1. **Protecci√≥n del super-admin principal:** NADIE puede editarlo
  2. **Protecci√≥n de super-admins:** Solo otros super-admins pueden editarlos
  3. **Protecci√≥n de asignaci√≥n de rol:** Solo el super-admin principal puede asignar el rol `super_admin`

```typescript
// üîê PROTECCI√ìN CR√çTICA: NADIE puede editar al super-admin principal
if (isMainSuperAdmin(userProfile.email)) {
  throw new Error('No se puede editar al super administrador principal');
}

// Obtener el perfil del usuario que est√° haciendo la actualizaci√≥n
const updaterProfile = await getUserProfile(updatedBy);
if (!updaterProfile) {
  throw new Error('Usuario actualizador no encontrado');
}

// üîê PROTECCI√ìN: Solo super-admins pueden editar a otros super-admins
if (userProfile.role === 'super_admin' && updaterProfile.role !== 'super_admin') {
  throw new Error('Solo un super administrador puede editar a otro super administrador');
}

// üîê PROTECCI√ìN: Solo el super-admin principal puede asignar el rol de super_admin
if (updates.role === 'super_admin') {
  if (updaterProfile.email !== 'mar90jesus@gmail.com') {
    throw new Error('Solo el super administrador principal puede asignar el rol de Super Administrador');
  }
}
```

### 5. Backend - Funci√≥n de Aprobaci√≥n de Registros
**Archivo:** `lib/auth.ts` - Funci√≥n `approveRegistration`

**Cambios:**
- Se agreg√≥ validaci√≥n para verificar que solo el super-admin principal puede aprobar registros con rol `super_admin`
- Se obtiene el perfil del usuario aprobador
- Se verifica que sea `mar90jesus@gmail.com` antes de permitir la aprobaci√≥n

```typescript
// üîê PROTECCI√ìN: Solo el super-admin principal puede aprobar con rol de super_admin
if (approvedRole === 'super_admin') {
  const approverProfile = await getUserProfile(approvedBy);
  if (!approverProfile || approverProfile.email !== 'mar90jesus@gmail.com') {
    throw new Error('Solo el super administrador principal puede aprobar usuarios con el rol de Super Administrador');
  }
}
```

### 6. Backend - Funci√≥n de Cambio de Estado de Usuarios (MEJORADA)
**Archivo:** `lib/auth.ts` - Funci√≥n `changeUserStatus`

**Cambios:**
- Se agregaron **DOS niveles de protecci√≥n** adicionales en el backend:
  1. **Protecci√≥n del super-admin principal:** NADIE puede modificar su estado
  2. **Protecci√≥n de super-admins:** Solo otros super-admins pueden modificar el estado de un super-admin

**Nota:** Esta funci√≥n es usada por `deleteUserAsAdmin`, `reactivateUser` y `recoverUser`, por lo que la protecci√≥n aplica a todas estas operaciones.

```typescript
// üîê PROTECCI√ìN CR√çTICA: No se puede modificar el estado del super admin principal
if (isMainSuperAdmin(userData.email)) {
  throw new Error('No se puede modificar el estado del super administrador principal. Este usuario tiene protecci√≥n permanente.');
}

// Obtener el perfil del usuario que est√° haciendo el cambio
const changerProfile = await getUserProfile(changedBy);
if (!changerProfile) {
  throw new Error('Usuario que realiza el cambio no encontrado');
}

// üîê PROTECCI√ìN: Solo super-admins pueden modificar el estado de otros super-admins
if (userData.role === 'super_admin' && changerProfile.role !== 'super_admin') {
  throw new Error('Solo un super administrador puede modificar el estado de otro super administrador');
}
```

**Funciones afectadas:**
- `deleteUserAsAdmin()` - Eliminar usuario
- `reactivateUser()` - Reactivar usuario
- `recoverUser()` - Recuperar usuario eliminado
- `changeUserStatus()` - Cambiar cualquier estado

## üîí Niveles de Protecci√≥n

### Nivel 1: Interfaz de Usuario (Visual)
- Los usuarios que no son el super-admin principal **no ven** la opci√≥n de seleccionar "Super Administrador"
- Los admins **no ven el bot√≥n de editar** para usuarios con rol super-admin
- Los admins **no ven botones de eliminar/desactivar** para usuarios con rol super-admin
- **NADIE** ve el bot√≥n de editar para el super-admin principal (mar90jesus@gmail.com)
- **NADIE** ve botones de eliminar/desactivar para el super-admin principal
- Mensajes informativos claros indicando las restricciones

### Nivel 2: Validaci√≥n de Cliente (Frontend)
- Los modales verifican la identidad del usuario antes de mostrar opciones
- Funci√≥n `canEditSpecificUser()` valida permisos de edici√≥n antes de mostrar botones
- Funci√≥n `canDeleteOrDeactivateSpecificUser()` valida permisos de eliminaci√≥n/desactivaci√≥n antes de mostrar botones
- Validaciones en `handleUpdateUser()` antes de enviar peticiones al servidor
- Validaciones en `handleDeleteUser()` y `showConfirmationModal()` antes de eliminar/desactivar
- Validaciones en `handleConfirmAction()` antes de ejecutar cualquier acci√≥n de estado
- Mensajes de error espec√≠ficos para cada tipo de restricci√≥n

### Nivel 3: Validaci√≥n de Servidor (Backend)
- Todas las funciones de backend validan m√∫ltiples niveles de permisos
- Triple verificaci√≥n en `updateUserAsAdmin()`:
  1. Protecci√≥n del super-admin principal
  2. Verificaci√≥n de permisos para editar super-admins
  3. Protecci√≥n de asignaci√≥n de rol super_admin
- Doble verificaci√≥n en `changeUserStatus()`:
  1. Protecci√≥n del super-admin principal
  2. Verificaci√≥n de permisos para modificar estado de super-admins
- Validaciones en:
  - Creaci√≥n de usuarios (API route + validaci√≥n de rol)
  - Actualizaci√≥n de usuarios (funci√≥n de auth + m√∫ltiples protecciones)
  - Aprobaci√≥n de registros (funci√≥n de auth + validaci√≥n de rol)
  - Cambio de estado (eliminar, desactivar, reactivar, recuperar)

## üß™ Casos de Prueba

### ‚úÖ Caso 1: Super-Admin Principal (mar90jesus@gmail.com)
**Usuario:** mar90jesus@gmail.com  
**Acciones permitidas:**
- ‚úÖ Puede ver la opci√≥n "Super Administrador" al crear usuarios
- ‚úÖ Puede ver la opci√≥n "Super Administrador" al editar usuarios
- ‚úÖ Puede asignar el rol super_admin sin errores
- ‚úÖ Puede aprobar registros con rol super_admin
- ‚úÖ Puede editar a cualquier usuario (excepto a s√≠ mismo)
- ‚úÖ Control total sobre la gesti√≥n de usuarios
- ‚ùå NO puede editarse a s√≠ mismo (protecci√≥n absoluta)

### üü° Caso 2: Super-Admin Secundario
**Usuario:** Cualquier super-admin que NO sea mar90jesus@gmail.com  
**Acciones permitidas:**
- ‚úÖ Puede editar a otros super-admins
- ‚úÖ Puede editar a usuarios de cualquier rol
- ‚úÖ Ve el bot√≥n de editar para super-admins
- ‚ùå NO ve la opci√≥n "Super Administrador" al crear usuarios
- ‚ùå NO puede asignar el rol super_admin
- ‚ùå NO puede editar a mar90jesus@gmail.com
- ‚ùå NO puede aprobar registros con rol super_admin

### ‚ùå Caso 3: Usuario Admin Regular
**Usuario:** Cualquier admin que NO sea super-admin  
**Resultado esperado:**
- ‚ùå NO ve la opci√≥n "Super Administrador" al crear usuarios
- ‚ùå NO ve la opci√≥n "Super Administrador" al editar usuarios
- ‚ùå NO ve el bot√≥n de editar para usuarios super-admin
- ‚ùå NO puede editar a mar90jesus@gmail.com
- ‚ùå Ve mensaje informativo sobre la restricci√≥n
- ‚ùå Si intenta editar un super-admin, recibe error: "Solo un super administrador puede editar a otro super administrador"

### üõë Caso 4: Intento de Editar al Super-Admin Principal
**Escenario:** Cualquier usuario (incluso super-admin) intenta editar a mar90jesus@gmail.com  
**Resultado esperado:**
- ‚ùå NO ve el bot√≥n de editar
- ‚ùå Si intenta forzar la edici√≥n, recibe error: "No se puede editar al super administrador principal"
- ‚ùå La operaci√≥n es bloqueada en el backend
- üîí Protecci√≥n absoluta del super-admin principal

### üõë Caso 5: Admin Intenta Editar Super-Admin
**Escenario:** Un admin intenta editar a un usuario con rol super_admin  
**Resultado esperado:**
- ‚ùå NO ve el bot√≥n de editar (protecci√≥n visual)
- ‚ùå Si intenta forzar la edici√≥n (bypass frontend), recibe error en el backend
- ‚ùå Error: "Solo un super administrador puede editar a otro super administrador"
- ‚ùå La operaci√≥n no se completa

### üõë Caso 6: Intento de Bypass - Asignar Rol Super-Admin
**Escenario:** Admin/Super-admin secundario intenta manipular el c√≥digo del cliente para asignar rol super_admin  
**Resultado esperado:**
- ‚ùå El backend rechaza la petici√≥n
- ‚ùå Se muestra error: "Solo el super administrador principal puede asignar el rol de Super Administrador"
- ‚ùå La operaci√≥n no se completa

## üìç Ubicaci√≥n de Archivos Modificados

```
callejerusalen.com/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin-dashboard/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx                    ‚Üê Modales de crear/editar usuario
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îî‚îÄ‚îÄ admin/
‚îÇ           ‚îî‚îÄ‚îÄ create-user/
‚îÇ               ‚îî‚îÄ‚îÄ route.ts                ‚Üê API de creaci√≥n de usuarios
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ auth.ts                             ‚Üê Funciones updateUserAsAdmin y approveRegistration
```

## üé® Experiencia de Usuario

### Para Super-Admin Principal (mar90jesus@gmail.com)
- Experiencia sin cambios
- Todas las opciones disponibles
- Control total sobre asignaci√≥n de roles

### Para Administradores Regulares
- Interfaz limpia sin opciones no disponibles
- Mensaje claro explicando la restricci√≥n
- No se generan errores ni confusi√≥n

## üîê Seguridad

### Protecciones Implementadas
1. **Validaci√≥n de Frontend:** Oculta opciones no disponibles
2. **Validaci√≥n de Backend en API Routes:** Verifica permisos antes de crear usuarios
3. **Validaci√≥n de Backend en Funciones:** Verifica permisos antes de actualizar o aprobar
4. **Verificaci√≥n de Email Hardcoded:** Usa el email `mar90jesus@gmail.com` como constante de seguridad

### Consideraciones de Seguridad
- ‚ö†Ô∏è El email del super-admin principal est√° hardcoded en m√∫ltiples lugares
- ‚úÖ Esto es intencional para m√°xima seguridad
- ‚úÖ M√∫ltiples capas de validaci√≥n evitan bypass
- ‚úÖ Las validaciones de servidor son la protecci√≥n final

## üìù Notas Adicionales

### Email del Super-Admin Principal
El email `mar90jesus@gmail.com` est√° definido en:
- `CreateUserModal` component
- `EditUserModal` component
- `app/api/admin/create-user/route.ts`
- `lib/auth.ts` (funciones `updateUserAsAdmin` y `approveRegistration`)
- `context/AuthContext.tsx` (para protecci√≥n de acceso)

### Compatibilidad
- ‚úÖ Compatible con el sistema de permisos existente
- ‚úÖ No afecta otras funcionalidades del dashboard
- ‚úÖ Mantiene la protecci√≥n existente del super-admin principal

## ‚úÖ Estado

**Implementaci√≥n completa** - Protecci√≥n multi-nivel implementada  
**Fecha:** 9 de Octubre, 2025  
**Versi√≥n:** 2.0 (Mejorada)

### Cambios en esta versi√≥n:
- ‚úÖ Protecci√≥n visual para botones de editar
- ‚úÖ Funci√≥n `canEditSpecificUser()` para validaciones espec√≠ficas
- ‚úÖ Validaciones en `handleUpdateUser()` con mensajes claros
- ‚úÖ Triple protecci√≥n en backend para `updateUserAsAdmin()`
- ‚úÖ Protecci√≥n absoluta del super-admin principal
- ‚úÖ Solo super-admins pueden editar a otros super-admins

## üöÄ Despliegue

No se requieren cambios en:
- Base de datos
- Variables de entorno
- Configuraci√≥n de Firebase
- Migraciones

Los cambios son solo de c√≥digo y entran en efecto inmediatamente despu√©s del despliegue.

