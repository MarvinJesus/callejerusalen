# Sistema de Notificaciones de P√°nico

## üìã Descripci√≥n General

Se ha implementado un sistema completo de notificaciones en tiempo real para alertas de p√°nico, que incluye:

- ‚úÖ **Sonido de alarma intermitente** (generado con Web Audio API)
- ‚úÖ **Notificaciones del navegador** (Web Push API)
- ‚úÖ **Alertas visuales en tiempo real**
- ‚úÖ **Escucha en tiempo real de Firestore**
- ‚úÖ **Notificaci√≥n selectiva** (solo usuarios seleccionados)

---

## üéØ Caracter√≠sticas Principales

### 1. Sonido de Alarma Intermitente

**Archivo:** `lib/alarmSound.ts`

El sistema genera sonidos de alarma sin necesidad de archivos de audio externos:

- **Patr√≥n Simple**: Un tono continuo intermitente
- **Patr√≥n de Emergencia**: Dos tonos alternados (La - 880Hz y Mi - 659Hz)
- **Controles**: 
  - `startAlarm()` - Inicia la alarma
  - `stopAlarm()` - Detiene la alarma
  - `isPlaying()` - Verifica si est√° sonando

```typescript
import { useAlarmSound } from '@/lib/alarmSound';

const { startAlarm, stopAlarm, isPlaying } = useAlarmSound();

// Iniciar alarma de emergencia (patr√≥n alternado)
startAlarm('emergency');

// Iniciar alarma simple
startAlarm('simple');

// Detener alarma
stopAlarm();
```

### 2. Hook de Notificaciones en Tiempo Real

**Archivo:** `hooks/usePanicNotifications.ts`

Este hook se conecta a Firestore y escucha cambios en tiempo real:

```typescript
import { usePanicNotifications } from '@/hooks/usePanicNotifications';

const {
  notifications,          // Todas las notificaciones
  activeNotifications,    // Solo notificaciones activas
  unreadCount,           // Cantidad de notificaciones no le√≠das
  markAsRead,            // Marcar como le√≠da
  markAllAsRead,         // Marcar todas como le√≠das
  loading,               // Estado de carga
  error                  // Errores
} = usePanicNotifications((notification) => {
  // Callback cuando llega nueva notificaci√≥n
  console.log('Nueva alerta:', notification);
});
```

**Caracter√≠sticas:**
- Escucha cambios en la colecci√≥n `panicReports`
- Solo recibe notificaciones donde el usuario est√° en `notifiedUsers`
- Persiste notificaciones le√≠das en localStorage
- Detecta autom√°ticamente nuevas alertas activas

### 3. Componente de Notificaciones

**Archivo:** `components/PanicNotificationSystem.tsx`

Componente visual que integra todo el sistema:

**Caracter√≠sticas:**
- ‚úÖ Modal visual con informaci√≥n de la emergencia
- ‚úÖ Sonido de alarma autom√°tico
- ‚úÖ Notificaciones del navegador
- ‚úÖ Control de sonido (activar/desactivar)
- ‚úÖ Bot√≥n de llamada al 911
- ‚úÖ Informaci√≥n detallada del solicitante
- ‚úÖ Indicadores especiales (Modo Extremo, Video)

### 4. Integraci√≥n con Notificaciones del Navegador

El sistema solicita permisos autom√°ticamente para notificaciones del navegador:

```typescript
// Solicitar permisos (se hace autom√°ticamente)
Notification.requestPermission().then((permission) => {
  if (permission === 'granted') {
    // Notificaciones activadas
  }
});
```

**Caracter√≠sticas de las notificaciones del navegador:**
- üîî Requiere interacci√≥n del usuario
- üîî Vibraci√≥n en dispositivos m√≥viles
- üîî Sonido nativo del sistema
- üîî Persisten aunque cambies de pesta√±a
- üîî Al hacer clic, te lleva a la alerta

---

## üîß Implementaci√≥n

### Archivos Creados/Modificados

1. **`lib/alarmSound.ts`** (NUEVO)
   - Utilidad para generar sonidos de alarma con Web Audio API
   - Patr√≥n singleton para una √∫nica instancia
   - Hook `useAlarmSound()` para React

2. **`hooks/usePanicNotifications.ts`** (NUEVO)
   - Hook personalizado para escuchar notificaciones en tiempo real
   - Gesti√≥n de estado de notificaciones le√≠das/no le√≠das
   - Callback para nuevas notificaciones

3. **`components/PanicNotificationSystem.tsx`** (NUEVO)
   - Componente visual del sistema de notificaciones
   - Integraci√≥n de sonido y notificaciones del navegador
   - Modal con informaci√≥n detallada de la emergencia

4. **`app/layout.tsx`** (MODIFICADO)
   - Agregado `<PanicNotificationSystem />` dentro de `AuthProvider`
   - Disponible en toda la aplicaci√≥n

5. **`firestore.rules`** (MODIFICADO)
   - Actualizada regla de `panicReports` para permitir lectura a usuarios notificados
   - Agregada verificaci√≥n: `request.auth.uid in resource.data.notifiedUsers`

---

## üöÄ Uso del Sistema

### Para Usuarios que Activan el P√°nico

1. El usuario activa el bot√≥n de p√°nico (flotante o desde la p√°gina)
2. Se crea un documento en `panicReports` con los usuarios a notificar
3. El sistema env√≠a la alerta autom√°ticamente

### Para Usuarios que Reciben la Notificaci√≥n

1. **Sonido de Alarma**:
   - Se reproduce autom√°ticamente al recibir la alerta
   - Patr√≥n alternado de dos tonos para m√°xima urgencia
   - Se puede desactivar desde el modal

2. **Notificaci√≥n del Navegador**:
   - Aparece incluso si est√°s en otra pesta√±a
   - Vibra en dispositivos m√≥viles
   - Al hacer clic, muestra el modal de la alerta

3. **Modal Visual**:
   - Informaci√≥n del solicitante (nombre, email)
   - Ubicaci√≥n de la emergencia
   - Descripci√≥n de la situaci√≥n
   - Tiempo transcurrido desde la activaci√≥n
   - Bot√≥n directo para llamar al 911
   - Indicadores especiales (Modo Extremo, Video)

4. **Acciones Disponibles**:
   - ‚úÖ **Llamar al 911**: Abre el marcador telef√≥nico
   - ‚úÖ **He sido notificado**: Marca la alerta como le√≠da y cierra el modal
   - ‚úÖ **Toggle de sonido**: Activar/desactivar sonido de alarma

---

## üìä Estructura de Datos

### PanicReport en Firestore

```typescript
{
  id: string,                    // ID del documento
  userId: string,                // ID del usuario que activ√≥
  userName: string,              // Nombre del usuario
  userEmail: string,             // Email del usuario
  location: string,              // Ubicaci√≥n de la emergencia
  description: string,           // Descripci√≥n
  timestamp: Timestamp,          // Fecha/hora de activaci√≥n
  status: 'active' | 'resolved', // Estado de la alerta
  emergencyContacts: string[],   // Contactos de emergencia (ej. ['911'])
  notifiedUsers: string[],       // Array de UIDs notificados
  activatedFrom?: string,        // Origen de activaci√≥n
  extremeMode?: boolean,         // Si modo extremo est√° activo
  hasVideo?: boolean             // Si hay video capturado
}
```

### Regla de Firestore

```javascript
match /panicReports/{reportId} {
  allow create: if hasSecurityAccess();
  allow read: if request.auth != null && 
    (isAdminOrSuperAdmin() || 
     hasSecurityAccess() ||
     request.auth.uid in resource.data.notifiedUsers);
  allow update: if request.auth != null && 
    (isAdminOrSuperAdmin() || request.auth.uid == resource.data.userId);
  allow delete: if isAdminOrSuperAdmin();
}
```

**La parte clave es:**
```javascript
request.auth.uid in resource.data.notifiedUsers
```

Esto permite que solo los usuarios en el array `notifiedUsers` puedan leer el reporte.

---

## üé® Personalizaci√≥n

### Cambiar el Sonido de Alarma

En `lib/alarmSound.ts`, puedes modificar:

```typescript
// Frecuencia del tono (en Hz)
const frequency = 880; // La alta (default)

// Duraci√≥n de cada beep (en ms)
const duration = 200;

// Intervalo entre beeps (en ms)
const interval = 300;
```

### Cambiar el Patr√≥n de Emergencia

```typescript
// En startEmergencyPattern()
const frequency = highTone ? 880 : 659; // Modificar frecuencias
```

### Personalizar Notificaciones del Navegador

En `components/PanicNotificationSystem.tsx`:

```typescript
const browserNotification = new Notification('üö® ALERTA DE P√ÅNICO', {
  body: `...`,
  icon: '/logo.png',           // Cambiar icono
  badge: '/logo.png',          // Cambiar badge
  requireInteraction: true,    // Requiere interacci√≥n
  vibrate: [200, 100, 200],    // Patr√≥n de vibraci√≥n
});
```

---

## üîê Seguridad

### Permisos Requeridos

1. **Firestore**:
   - Usuario debe estar en `notifiedUsers` del reporte
   - O tener `hasSecurityAccess()` (inscrito en plan de seguridad)
   - O ser admin/super_admin

2. **Notificaciones del Navegador**:
   - Requiere permiso expl√≠cito del usuario
   - Se solicita autom√°ticamente la primera vez
   - Puede activarse/desactivarse en cualquier momento

3. **Audio**:
   - No requiere permisos especiales
   - Algunos navegadores requieren interacci√≥n del usuario primero
   - Se maneja autom√°ticamente con AudioContext

---

## üß™ Pruebas

### Probar el Sistema Completo

1. **Configurar contactos de emergencia**:
   - Usuario A: Ir a `/residentes/panico` ‚Üí Configuraci√≥n
   - Seleccionar Usuario B como contacto

2. **Activar p√°nico**:
   - Usuario A: Activar bot√≥n de p√°nico
   - Se crea el reporte en Firestore

3. **Verificar notificaci√≥n**:
   - Usuario B: Debe recibir:
     - ‚úÖ Sonido de alarma autom√°tico
     - ‚úÖ Notificaci√≥n del navegador
     - ‚úÖ Modal visual con la alerta
     - ‚úÖ Toast de React Hot Toast

4. **Interactuar con la alerta**:
   - Usuario B: Puede:
     - Ver informaci√≥n completa
     - Llamar al 911
     - Desactivar el sonido
     - Marcar como le√≠da

### Probar Solo el Sonido

```typescript
import { getAlarmSound } from '@/lib/alarmSound';

const alarm = getAlarmSound();
alarm.startEmergencyPattern(); // Iniciar
alarm.stop(); // Detener
```

### Verificar Permisos

```typescript
// En consola del navegador
console.log('Permiso de notificaciones:', Notification.permission);

// Valores posibles: 'default', 'granted', 'denied'
```

---

## üêõ Soluci√≥n de Problemas

### El sonido no se reproduce

**Causa**: El navegador requiere interacci√≥n del usuario antes de reproducir audio.

**Soluci√≥n**: El AudioContext se reanuda autom√°ticamente, pero en algunos navegadores puede requerir un clic previo.

```typescript
// Forzar inicio de AudioContext
if (audioContext.state === 'suspended') {
  audioContext.resume();
}
```

### Las notificaciones del navegador no aparecen

**Causa**: Permisos no otorgados o bloqueados.

**Soluci√≥n**: 
1. Verificar permisos en configuraci√≥n del navegador
2. Usar el bot√≥n "Activar notificaciones de emergencia" en la esquina inferior izquierda
3. Verificar que el navegador soporte notificaciones

### No recibo notificaciones

**Causa**: No est√°s en la lista de `notifiedUsers`.

**Soluci√≥n**: 
1. Verificar que el usuario que activ√≥ el p√°nico te haya seleccionado
2. Verificar en Firestore que tu UID est√° en el array `notifiedUsers`
3. Verificar que tengas acceso al plan de seguridad

### El listener no se conecta

**Causa**: Problemas con las reglas de Firestore o conexi√≥n.

**Soluci√≥n**:
1. Verificar reglas en Firebase Console
2. Comprobar logs en consola del navegador
3. Verificar que est√©s autenticado

---

## üì± Compatibilidad

### Navegadores Soportados

| Caracter√≠stica | Chrome | Firefox | Safari | Edge |
|---------------|--------|---------|--------|------|
| Web Audio API | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Notificaciones | ‚úÖ | ‚úÖ | ‚úÖ* | ‚úÖ |
| Firestore Listeners | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Vibraci√≥n | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ |

*Safari en iOS requiere agregar la app a la pantalla de inicio.

### Dispositivos M√≥viles

- ‚úÖ **Android**: Soporte completo
- ‚ö†Ô∏è **iOS**: Notificaciones limitadas (requiere PWA)
- ‚úÖ **Sonido**: Funciona en todos los dispositivos
- ‚úÖ **Vibraci√≥n**: Android y dispositivos compatibles

---

## üîÑ Flujo de Notificaci√≥n Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    USUARIO A (Activador)                     ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  1. Activa bot√≥n de p√°nico                                   ‚îÇ
‚îÇ  2. Se crea documento en panicReports                        ‚îÇ
‚îÇ     - notifiedUsers: ['user_b_uid', 'user_c_uid']           ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FIRESTORE (panicReports)                  ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  {                                                            ‚îÇ
‚îÇ    userId: 'user_a_uid',                                     ‚îÇ
‚îÇ    userName: 'Usuario A',                                    ‚îÇ
‚îÇ    notifiedUsers: ['user_b_uid', 'user_c_uid'],            ‚îÇ
‚îÇ    status: 'active',                                         ‚îÇ
‚îÇ    timestamp: ServerTimestamp                                ‚îÇ
‚îÇ  }                                                            ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              USUARIOS B y C (Notificados)                    ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  usePanicNotifications Hook:                                 ‚îÇ
‚îÇ  ‚îÇ                                                            ‚îÇ
‚îÇ  ‚îú‚îÄ onSnapshot detecta nuevo documento                       ‚îÇ
‚îÇ  ‚îú‚îÄ Verifica: uid in notifiedUsers ‚úÖ                        ‚îÇ
‚îÇ  ‚îú‚îÄ Ejecuta callback onNewNotification()                     ‚îÇ
‚îÇ  ‚îÇ                                                            ‚îÇ
‚îÇ  PanicNotificationSystem:                                    ‚îÇ
‚îÇ  ‚îÇ                                                            ‚îÇ
‚îÇ  ‚îú‚îÄ üîä Inicia sonido de alarma (startAlarm)                 ‚îÇ
‚îÇ  ‚îú‚îÄ üì¢ Muestra notificaci√≥n del navegador                    ‚îÇ
‚îÇ  ‚îú‚îÄ üñºÔ∏è Abre modal visual con informaci√≥n                    ‚îÇ
‚îÇ  ‚îî‚îÄ üçû Muestra toast de React Hot Toast                      ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Usuario interact√∫a:                                         ‚îÇ
‚îÇ  ‚îú‚îÄ ‚òéÔ∏è Llama al 911                                          ‚îÇ
‚îÇ  ‚îú‚îÄ ‚úÖ Marca como le√≠da                                      ‚îÇ
‚îÇ  ‚îú‚îÄ üîá Desactiva sonido                                      ‚îÇ
‚îÇ  ‚îî‚îÄ ‚ùå Cierra modal                                          ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù Notas Importantes

1. **Rendimiento**: El sistema usa Firestore listeners en tiempo real, que cuenta hacia tu cuota de lecturas de Firestore.

2. **Persistencia**: Las notificaciones le√≠das se guardan en localStorage, por lo que persisten entre sesiones.

3. **Privacidad**: Solo los usuarios en `notifiedUsers` pueden ver la informaci√≥n de la alerta.

4. **Sonido**: El sonido se genera din√°micamente y no requiere archivos de audio, reduciendo el tama√±o de la aplicaci√≥n.

5. **Escalabilidad**: El sistema est√° dise√±ado para manejar m√∫ltiples alertas simult√°neas.

---

## üéØ Pr√≥ximas Mejoras Sugeridas

- [ ] Panel de historial de notificaciones recibidas
- [ ] Respuestas r√°pidas (ej. "Voy en camino", "Contact√© a emergencias")
- [ ] Mapa en tiempo real con ubicaci√≥n del solicitante
- [ ] Chat en tiempo real entre notificados
- [ ] Estad√≠sticas de tiempo de respuesta
- [ ] Notificaciones push con Firebase Cloud Messaging (para iOS)
- [ ] Integraci√≥n con servicios de emergencia externos
- [ ] Sistema de reconocimiento para false alarms

---

## üìû Contacto de Soporte

Si encuentras problemas o tienes sugerencias, contacta al equipo de desarrollo.

---

**√öltima actualizaci√≥n**: Octubre 2025  
**Versi√≥n**: 1.0.0  
**Sistema implementado por**: AI Assistant (Claude Sonnet 4.5)


